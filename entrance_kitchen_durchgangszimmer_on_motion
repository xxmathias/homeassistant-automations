alias: entrance_kitchen_durchgangszimmer_on_motion
triggers:
  - entity_id:
      - binary_sensor.bewegungssensor1_occupancy
      - binary_sensor.bewegungssensor2_licht_occupancy
    to: "on"
    trigger: state
conditions:
  - condition: or
    conditions:
      - condition: numeric_state
        entity_id: sensor.sun_solar_elevation
        below: 30
      - condition: numeric_state
        entity_id: sensor.bewegungssensor1_illuminance
        below: 45
actions:
  - choose:
      # Specific case for entrance motion sensor
      - conditions:
          - condition: trigger
            id: binary_sensor.bewegungssensor1_occupancy
          - condition: numeric_state
            entity_id: sensor.bewegungssensor1_illuminance
            below: 45
        sequence:
          - target:
              area_id:
                - entrance
            data:
              transition: 2
              brightness_pct: 75
            action: light.turn_on
            
      # Specific case for kitchen/durchgangszimmer motion sensor
      - conditions:
          - condition: trigger
            id: binary_sensor.bewegungssensor2_licht_occupancy
          - condition: numeric_state
            entity_id: sensor.bewegungssensor1_illuminance
            below: 45
        sequence:
          - target:
              area_id:
                - durchgangszimmer
                - kuche
            data:
              transition: 2
              brightness_pct: 75
            action: light.turn_on
    
    # Default case if none of the above match
    default:
      - condition: numeric_state
        entity_id: sensor.bewegungssensor1_illuminance
        below: 45
      - target:
          area_id:
            - entrance
            - durchgangszimmer
            - kuche
        data:
          transition: 2
          brightness_pct: 75
        action: light.turn_on
        
  # Wait for motion to stop before turning off lights
  - wait_for_trigger:
      - entity_id:
          - binary_sensor.bewegungssensor1_occupancy
          - binary_sensor.bewegungssensor2_licht_occupancy
          - binary_sensor.bewegungssensor_durchgangszimmer
        to: "off"
        for:
          hours: 0
          minutes: 2
          seconds: 0
        trigger: state
    continue_on_timeout: false
    
  # Only turn off lights if no presence detected
  - condition: and
    conditions:
      - condition: state
        entity_id: binary_sensor.praesenzsensor_presence
        state: "off"
      - condition: state
        entity_id: binary_sensor.praesenzsensor2_presence
        state: "off"
  - action: light.turn_off
    data:
      transition: 2
    target:
      area_id:
        - kuche
        - durchgangszimmer
        - entrance
mode: restart
